using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using JurisFlow.Server.Data;
using JurisFlow.Server.Enums;
using JurisFlow.Server.Models;
using JurisFlow.Server.Services;
using System.Globalization;
using System.Text;

namespace JurisFlow.Server.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class InvoicesController : ControllerBase
    {
        private readonly JurisFlowDbContext _context;
        private readonly AuditLogger _auditLogger;
        private readonly FirmStructureService _firmStructure;

        public InvoicesController(JurisFlowDbContext context, AuditLogger auditLogger, FirmStructureService firmStructure)
        {
            _context = context;
            _auditLogger = auditLogger;
            _firmStructure = firmStructure;
        }

        private async Task<bool> IsPeriodLocked(DateTime date)
        {
            var key = date.ToString("yyyy-MM-dd");
            return await _context.BillingLocks.AnyAsync(b => string.Compare(key, b.PeriodStart) >= 0 && string.Compare(key, b.PeriodEnd) <= 0);
        }

        private static void RecalculateTotals(Invoice invoice)
        {
            var subtotal = invoice.LineItems.Sum(li => li.Amount);
            var total = subtotal + invoice.Tax - invoice.Discount;
            invoice.Subtotal = subtotal;
            invoice.Total = total;
            invoice.Balance = total - invoice.AmountPaid;
        }

        // GET: api/Invoices
        [HttpGet]
        public async Task<IActionResult> GetInvoices([FromQuery] string? entityId, [FromQuery] string? officeId)
        {
            var query = _context.Invoices.AsQueryable();

            if (!string.IsNullOrWhiteSpace(entityId))
            {
                query = query.Where(i => i.EntityId == entityId);
            }

            if (!string.IsNullOrWhiteSpace(officeId))
            {
                query = query.Where(i => i.OfficeId == officeId);
            }

            var invoices = await query
                .Include(i => i.LineItems)
                .OrderByDescending(i => i.IssueDate)
                .ToListAsync();
            return Ok(invoices);
        }

        // GET: api/Invoices/{id}
        [HttpGet("{id}")]
        public async Task<IActionResult> GetInvoice(string id)
        {
            var invoice = await _context.Invoices.Include(i => i.LineItems).FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();
            return Ok(invoice);
        }

        // POST: api/Invoices
        [HttpPost]
        public async Task<IActionResult> CreateInvoice([FromBody] InvoiceCreateDto dto)
        {
            if (await IsPeriodLocked(dto.IssueDate ?? DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot create invoice." });
            }

            var billingSettings = await GetBillingSettingsAsync();
            var invoiceNumber = string.IsNullOrWhiteSpace(dto.Number)
                ? await GenerateInvoiceNumberAsync(billingSettings.InvoicePrefix)
                : dto.Number;

            if (billingSettings.UtbmsCodesRequired && dto.LineItems != null)
            {
                var issues = GetUtbmsIssues(dto.LineItems);
                if (issues.Count > 0)
                {
                    return BadRequest(new { message = "UTBMS codes are required for this invoice.", issues });
                }
            }

            var (resolvedEntityId, resolvedOfficeId) = await _firmStructure.ResolveEntityOfficeFromMatterAsync(dto.MatterId, dto.EntityId, dto.OfficeId);

            var invoice = new Invoice
            {
                Id = Guid.NewGuid().ToString(),
                Number = invoiceNumber,
                ClientId = dto.ClientId,
                MatterId = dto.MatterId,
                EntityId = resolvedEntityId,
                OfficeId = resolvedOfficeId,
                Status = dto.Status ?? InvoiceStatus.Draft,
                IssueDate = dto.IssueDate ?? DateTime.UtcNow,
                DueDate = dto.DueDate,
                Notes = dto.Notes,
                Terms = dto.Terms,
                Discount = dto.Discount ?? 0,
                Tax = dto.Tax ?? 0,
                AmountPaid = 0
            };

            if (dto.LineItems != null)
            {
                foreach (var li in dto.LineItems)
                {
                    invoice.LineItems.Add(new InvoiceLineItem
                    {
                        Id = Guid.NewGuid().ToString(),
                        Type = li.Type ?? "time",
                        Description = li.Description ?? string.Empty,
                        Quantity = li.Quantity ?? 1,
                        Rate = li.Rate ?? 0,
                        Amount = (li.Quantity ?? 1) * (li.Rate ?? 0),
                        TaskCode = NormalizeUtbmsCode(li.TaskCode),
                        ExpenseCode = NormalizeUtbmsCode(li.ExpenseCode),
                        ActivityCode = NormalizeUtbmsCode(li.ActivityCode),
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    });
                }
            }

            RecalculateTotals(invoice);

            _context.Invoices.Add(invoice);
            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.create", "Invoice", invoice.Id, $"Client={invoice.ClientId}, Total={invoice.Total}");

            return CreatedAtAction(nameof(GetInvoice), new { id = invoice.Id }, invoice);
        }

        // PUT: api/Invoices/{id}
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateInvoice(string id, [FromBody] InvoiceUpdateDto dto)
        {
            var invoice = await _context.Invoices.Include(i => i.LineItems).FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();

            if (await IsPeriodLocked(DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot update invoice." });
            }

            if (!string.IsNullOrWhiteSpace(dto.Number)) invoice.Number = dto.Number;
            if (!string.IsNullOrWhiteSpace(dto.ClientId)) invoice.ClientId = dto.ClientId;
            if (!string.IsNullOrWhiteSpace(dto.MatterId)) invoice.MatterId = dto.MatterId;
            if (!string.IsNullOrWhiteSpace(dto.EntityId)) invoice.EntityId = dto.EntityId;
            if (!string.IsNullOrWhiteSpace(dto.OfficeId)) invoice.OfficeId = dto.OfficeId;
            if (dto.Status.HasValue) invoice.Status = dto.Status.Value;
            if (dto.IssueDate.HasValue) invoice.IssueDate = dto.IssueDate.Value;
            if (dto.DueDate.HasValue) invoice.DueDate = dto.DueDate.Value;
            if (dto.Notes != null) invoice.Notes = dto.Notes;
            if (dto.Terms != null) invoice.Terms = dto.Terms;
            if (dto.Discount is not null) invoice.Discount = dto.Discount.Value;
            if (dto.Tax is not null) invoice.Tax = dto.Tax.Value;

            // Replace line items if provided
            if (dto.LineItems != null)
            {
                var billingSettings = await GetBillingSettingsAsync();
                if (billingSettings.UtbmsCodesRequired)
                {
                    var issues = GetUtbmsIssues(dto.LineItems);
                    if (issues.Count > 0)
                    {
                        return BadRequest(new { message = "UTBMS codes are required for this invoice.", issues });
                    }
                }

                _context.InvoiceLineItems.RemoveRange(invoice.LineItems);
                invoice.LineItems.Clear();
                foreach (var li in dto.LineItems)
                {
                    invoice.LineItems.Add(new InvoiceLineItem
                    {
                        Id = Guid.NewGuid().ToString(),
                        InvoiceId = invoice.Id,
                        Type = li.Type ?? "time",
                        Description = li.Description ?? string.Empty,
                        Quantity = li.Quantity ?? 1,
                        Rate = li.Rate ?? 0,
                        Amount = (li.Quantity ?? 1) * (li.Rate ?? 0),
                        TaskCode = NormalizeUtbmsCode(li.TaskCode),
                        ExpenseCode = NormalizeUtbmsCode(li.ExpenseCode),
                        ActivityCode = NormalizeUtbmsCode(li.ActivityCode),
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    });
                }
            }

            RecalculateTotals(invoice);
            invoice.UpdatedAt = DateTime.UtcNow;

            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.update", "Invoice", invoice.Id, $"Status={invoice.Status}, Total={invoice.Total}");

            return Ok(invoice);
        }

        // POST: api/Invoices/{id}/pay
        [HttpPost("{id}/pay")]
        public async Task<IActionResult> ApplyPayment(string id, [FromBody] InvoicePaymentDto dto)
        {
            var invoice = await _context.Invoices.Include(i => i.LineItems).FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();

            if (await IsPeriodLocked(DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot apply payment." });
            }

            var amount = dto.Amount;
            if (amount <= 0) return BadRequest(new { message = "Amount must be positive" });

            invoice.AmountPaid += amount;
            invoice.Balance -= amount;
            if (invoice.Balance < 0) invoice.Balance = 0;

            if (invoice.Balance == 0)
            {
                invoice.Status = InvoiceStatus.Paid;
            }
            else if (invoice.Status == InvoiceStatus.Sent || invoice.Status == InvoiceStatus.Approved)
            {
                invoice.Status = InvoiceStatus.PartiallyPaid;
            }

            invoice.UpdatedAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.payment.apply", "Invoice", invoice.Id, $"Amount={amount}, Balance={invoice.Balance}");

            return Ok(invoice);
        }

        // GET: api/Invoices/{id}/ledes
        [HttpGet("{id}/ledes")]
        public async Task<IActionResult> ExportLedes(string id)
        {
            var invoice = await _context.Invoices.Include(i => i.LineItems).FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();

            var billingSettings = await GetBillingSettingsAsync();
            if (!billingSettings.LedesEnabled)
            {
                return BadRequest(new { message = "LEDES export is disabled in billing settings." });
            }

            if (billingSettings.UtbmsCodesRequired)
            {
                var issues = GetUtbmsIssues(invoice.LineItems.Select(li => new InvoiceLineItemDto
                {
                    Type = li.Type,
                    Description = li.Description,
                    Quantity = li.Quantity,
                    Rate = li.Rate,
                    TaskCode = li.TaskCode,
                    ExpenseCode = li.ExpenseCode,
                    ActivityCode = li.ActivityCode
                }).ToList());
                if (issues.Count > 0)
                {
                    return BadRequest(new { message = "UTBMS codes are required before exporting LEDES.", issues });
                }
            }

            var firmSettings = await GetFirmSettingsAsync();
            var lawFirmId = string.IsNullOrWhiteSpace(firmSettings.LedesFirmId) ? "JF-DEFAULT" : firmSettings.LedesFirmId;
            var firmName = string.IsNullOrWhiteSpace(firmSettings.FirmName) ? "JurisFlow" : firmSettings.FirmName;

            // LEDES 1998B export (pipe-delimited)
            var sb = new StringBuilder();
            sb.AppendLine("INVOICE_DATE|INVOICE_NUMBER|CLIENT_ID|LAW_FIRM_ID|LAW_FIRM_NAME|MATTER_ID|INVOICE_TOTAL");
            sb.AppendLine($"{invoice.IssueDate:yyyyMMdd}|{invoice.Number}|{invoice.ClientId}|{lawFirmId}|{firmName}|{invoice.MatterId}|{invoice.Total.ToString("F2", CultureInfo.InvariantCulture)}");
            sb.AppendLine("LINE_ITEM_NUMBER|LINE_ITEM_DATE|TASK_CODE|ACTIVITY_CODE|EXPENSE_CODE|LINE_ITEM_DESCRIPTION|LINE_ITEM_UNIT_COST|LINE_ITEM_UNITS|LINE_ITEM_TOTAL");

            int lineNo = 1;
            foreach (var li in invoice.LineItems)
            {
                var desc = (li.Description ?? string.Empty).Replace("|", "/");
                var units = li.Quantity;
                var unitCost = li.Rate;
                var fee = li.Amount;
                sb.AppendLine($"{lineNo}|{invoice.IssueDate:yyyyMMdd}|{NormalizeUtbmsCode(li.TaskCode)}|{NormalizeUtbmsCode(li.ActivityCode)}|{NormalizeUtbmsCode(li.ExpenseCode)}|{desc}|{unitCost.ToString("F2", CultureInfo.InvariantCulture)}|{units.ToString("F2", CultureInfo.InvariantCulture)}|{fee.ToString("F2", CultureInfo.InvariantCulture)}");
                lineNo++;
            }

            return File(Encoding.UTF8.GetBytes(sb.ToString()), "text/plain", $"invoice_{invoice.Number ?? invoice.Id}_ledes.dat");
        }

        // POST: api/Invoices/{id}/write-off
        [HttpPost("{id}/write-off")]
        public async Task<IActionResult> WriteOff(string id, [FromBody] InvoiceWriteOffDto dto)
        {
            var invoice = await _context.Invoices.FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();

            if (await IsPeriodLocked(DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot write off invoice." });
            }

            invoice.Status = InvoiceStatus.WrittenOff;
            invoice.Balance = 0;
            invoice.UpdatedAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.writeoff", "Invoice", invoice.Id, $"Reason={dto.Reason}");

            return Ok(invoice);
        }

        // POST: api/Invoices/{id}/cancel
        [HttpPost("{id}/cancel")]
        public async Task<IActionResult> Cancel(string id, [FromBody] InvoiceCancelDto dto)
        {
            var invoice = await _context.Invoices.FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NotFound();

            if (await IsPeriodLocked(DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot cancel invoice." });
            }

            invoice.Status = InvoiceStatus.Cancelled;
            invoice.Balance = 0;
            invoice.UpdatedAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.cancel", "Invoice", invoice.Id, $"Reason={dto.Reason}");

            return Ok(invoice);
        }

        // DELETE: api/Invoices/{id}
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteInvoice(string id)
        {
            var invoice = await _context.Invoices.Include(i => i.LineItems).FirstOrDefaultAsync(i => i.Id == id);
            if (invoice == null) return NoContent();

            if (await IsPeriodLocked(DateTime.UtcNow))
            {
                return BadRequest(new { message = "Billing period is locked. Cannot delete invoice." });
            }

            _context.InvoiceLineItems.RemoveRange(invoice.LineItems);
            _context.Invoices.Remove(invoice);
            await _context.SaveChangesAsync();
            await _auditLogger.LogAsync(HttpContext, "invoice.delete", "Invoice", id, "Deleted invoice");

            return NoContent();
        }

        private async Task<BillingSettings> GetBillingSettingsAsync()
        {
            var settings = await _context.BillingSettings.FirstOrDefaultAsync();
            if (settings == null)
            {
                settings = new BillingSettings();
                _context.BillingSettings.Add(settings);
                await _context.SaveChangesAsync();
            }
            return settings;
        }

        private async Task<FirmSettings> GetFirmSettingsAsync()
        {
            var settings = await _context.FirmSettings.FirstOrDefaultAsync();
            if (settings == null)
            {
                settings = new FirmSettings();
                _context.FirmSettings.Add(settings);
                await _context.SaveChangesAsync();
            }
            return settings;
        }

        private async Task<string> GenerateInvoiceNumberAsync(string prefix)
        {
            var normalized = string.IsNullOrWhiteSpace(prefix) ? "INV-" : prefix.Trim();
            if (!normalized.EndsWith("-", StringComparison.Ordinal))
            {
                normalized += "-";
            }

            var year = DateTime.UtcNow.Year;
            var yearPrefix = $"{normalized}{year}-";
            var count = await _context.Invoices.CountAsync(i => i.Number != null && i.Number.StartsWith(yearPrefix));
            return $"{yearPrefix}{(count + 1).ToString("D4", CultureInfo.InvariantCulture)}";
        }

        private List<string> GetUtbmsIssues(IEnumerable<InvoiceLineItemDto> lineItems)
        {
            var issues = new List<string>();
            var lineNumber = 1;

            foreach (var item in lineItems)
            {
                var type = (item.Type ?? string.Empty).Trim().ToLowerInvariant();
                var taskCode = NormalizeUtbmsCode(item.TaskCode);
                var activityCode = NormalizeUtbmsCode(item.ActivityCode);
                var expenseCode = NormalizeUtbmsCode(item.ExpenseCode);

                if (type == "time")
                {
                    if (string.IsNullOrWhiteSpace(activityCode))
                    {
                        issues.Add($"Line {lineNumber}: Activity code is required for time entries.");
                    }
                }

                if (type == "expense")
                {
                    if (string.IsNullOrWhiteSpace(expenseCode))
                    {
                        issues.Add($"Line {lineNumber}: Expense code is required for expense entries.");
                    }
                }

                lineNumber++;
            }

            return issues;
        }

        private string? NormalizeUtbmsCode(string? code)
        {
            if (string.IsNullOrWhiteSpace(code)) return null;
            var trimmed = code.Trim();
            var split = trimmed.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            return split.Length > 0 ? split[0].Trim() : trimmed;
        }
    }

    // DTOs
    public class InvoiceLineItemDto
    {
        public string? Type { get; set; }
        public string? Description { get; set; }
        public double? Quantity { get; set; }
        public double? Rate { get; set; }
        public string? TaskCode { get; set; }
        public string? ExpenseCode { get; set; }
        public string? ActivityCode { get; set; }
    }

    public class InvoiceCreateDto
    {
        public string? Number { get; set; }
        public string ClientId { get; set; } = string.Empty;
        public string? MatterId { get; set; }
        public string? EntityId { get; set; }
        public string? OfficeId { get; set; }
        public InvoiceStatus? Status { get; set; }
        public DateTime? IssueDate { get; set; }
        public DateTime? DueDate { get; set; }
        public double? Tax { get; set; }
        public double? Discount { get; set; }
        public string? Notes { get; set; }
        public string? Terms { get; set; }
        public List<InvoiceLineItemDto>? LineItems { get; set; }
    }

    public class InvoiceUpdateDto : InvoiceCreateDto
    {
    }

    public class InvoicePaymentDto
    {
        public double Amount { get; set; }
        public string? Reference { get; set; }
    }

    public class InvoiceWriteOffDto
    {
        public string? Reason { get; set; }
    }

    public class InvoiceCancelDto
    {
        public string? Reason { get; set; }
    }
}
